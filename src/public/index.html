<html>
    <head>
        <link rel="stylesheet" href="./styles.css">
        <title>Open-ICT Student Socializer</title>
    </head>
    <body onload="checkLogin(); setCookie('username', '', -1);">
        <div class="top-menu">

            <h1 class="page-top-text">User Settings</h1>

            <div class="menu">
                <a href="./index.html" class="active">home</a>
                <a href="#" class="menu-right" onclick="document.getElementById('id01').style.display='block'">login</a>
                <a href="#" class="menu-right">menu</a>
                <a href="#" class="menu-right">user</a>
            </div>
        </div>

        <!--<button onclick="document.getElementById('id01').style.display='block'" style="width:auto;">Login</button>-->

        <div id="id01" class="modal">
        
          <form class="modal-content animate" id="001_loginform">
            <div class="imgcontainer">
              <span onclick="document.getElementById('id01').style.display='none'; checkLogin()" class="close" title="Close Modal">&times;</span>
              <img src="./assets/avatar_icon.png" alt="Avatar" class="avatar">
            </div>
        
            <div class="container">

              <label for="username"><b>Username</b></label>
              <input id="lUsername" type="text" placeholder="Enter Username" name="username" required>
            
              <label for="password"><b>Password</b></label>
              <input id="lPassword" type="password" placeholder="Enter Password" name="password" required>

              <button onclick="Login(); document.getElementById('id01').style.display='none'">Login</button>
              <button onclick="document.getElementById('id01').style.display='none'; document.getElementById('id02').style.display='block'">Sign Up</button>
              <label>
                <input type="checkbox" name="remember" id="lRemember"> Remember me
              </label>
            </div>
        
            <div class="container" style="background-color:#f1f1f1">
              <button type="button" onclick="document.getElementById('id01').style.display='none'" class="cancelbtn">Cancel</button>
              <span class="psw">Forgot <a href="#">password?</a></span>
            </div>
          </form>
        </div>

        <div id="id02" class="modal">
        
            <form class="modal-content animate" id="001_signupform"  action="/signup" method="POST">
              <div class="imgcontainer">
                <span onclick="document.getElementById('id02').style.display='none'; checkLogin()" class="close" title="Close Modal">&times;</span>
                <img src="./assets/avatar_icon.png" alt="Avatar" class="avatar">
              </div>
          
              <div class="container">
  
                <label for="email"><b>E-mail</b></label>
                <input type="text" placeholder="Enter E-mail" name="email" required>
  
                <label for="username"><b>Username</b></label>
                <input type="text" placeholder="Enter Username" name="username" required>
              
                <label for="password"><b>Password</b></label>
                <input type="password" placeholder="Enter Password" name="password" required>
  
  
                <label for="location"><b>Start locatie</b></label>
                <input type="text" placeholder="Enter start locatie" name="location" required>
  
                <button type="submit">Sign Up</button>
                <button onclick="document.getElementById('id01').style.display='block'; document.getElementById('id02').style.display='none'">Login</button>
                <label>
                  <input type="checkbox" name="remember"> Remember me
                </label>
              </div>
          
              <div class="container" style="background-color:#f1f1f1">
                <button type="button" onclick="document.getElementById('id01').style.display='none'" class="cancelbtn">Cancel</button>
                <span class="psw">Forgot <a href="#">password?</a></span>
              </div>
            </form>
          </div>

          <div class="search">
            <form action="#">
              <label for="places">Please select your starting point for the trip</label>
              <select id="places" name="places">
                <option value="option1">option1</option>
                <option value="option2">option2</option>
                <option value="option3">option3</option>
              </select>
              <input id="SearchPlace" type="text" placeholder="search">
              <input type="submit">
            </form>
          </div>
    </body>
    <script>
        function setCookie(cname,cvalue,exdays) {
          const d = new Date();
          d.setTime(d.getTime() + (exdays*24*60*60*1000));
          let expires = "expires=" + d.toUTCString();
          document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
          let name = cname + "=";
          let decodedCookie = decodeURIComponent(document.cookie);
          let ca = decodedCookie.split(';');
          for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
              c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
              return c.substring(name.length, c.length);
            }
          }
          return "";
        }

        function checkLogin() {
          let username = getCookie("username");
          let passwordHash = getCookie("passwordhash");
          if (username != "") {
            alert("Welcome again " + username);
          } else {
                document.getElementById('id01').style.display='block'
            }
        }

        function Login(){
            let username = document.getElementById("lUsername").value;
            let checked = document.getElementById("lRemember").value;
            if (checked == "on"){
                setCookie("username", username, 1);
            }
        }

        async function signupFormSubmit() {
          const form = document.getElementById("001_signupform");
          if (form === null) {
            alert(`no signup form element`);
            return;
          }
          const formdata = new FormData(form);
          const destination = form.action;

          const response = await fetch(destination, {
            method: "POST",
            body: formdata,
            headers: {
              "Accept": "application/json",
              "Content-Type": "application/x-www-form-urlencoded"
            }
          })
            .catch(err => alert("something went wrong"));
            
          const responseData = await response.json();

          if (response.status === 200) {

            // succesfully signed up, store password and username
            setCookie("username", formdata.get("username"));
            setCookie("passwordhash", responseData.passwordHash);
          }
        }

        async function loginFormSubmit(formElement) {
          // WIP
        }

        function loadEventHandlers() {
          // prevent login and signup forms from reloading page
          document.getElementById("001_signupform").onsubmit = (ev => {
            ev.preventDefault();
            signupFormSubmit();
          });
          document.getElementById("001_loginform").onsubmit = (ev => {
            ev.preventDefault();
            loginFormSubmit(document.getElementById("001_loginform"));
          });
          // --------------------------
        }

        onload = loadEventHandlers;
    </script>
</html>